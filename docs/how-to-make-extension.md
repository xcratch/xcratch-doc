# How to Make Xcratch Extension

This guide explains how to create and debug Xcratch extensions following the editor's development workflow.

## Setting Up the Development Environment

### Directory Structure and Cloning

Xcratch uses a monorepo structure. Place [xcratch/scratch-editor](https://github.com/xcratch/scratch-editor) at the same level as your extension repository.

```
.
├── scratch-editor/          # monorepo root
│   └── packages/
│       ├── scratch-gui/     # Frontend UI
│       ├── scratch-vm/      # Virtual Machine
│       ├── scratch-render/  # Rendering Engine
│       └── ...
└── xcx-my-extension/        # Your extension
```

Clone the scratch-editor repository and install dependencies.

```sh
git clone https://github.com/xcratch/scratch-editor.git
cd scratch-editor
npm install
```

### Preparing HTTPS Certificates

The development server runs on HTTPS, so you need a certificate for your local machine. Use [mkcert](https://github.com/FiloSottile/mkcert) to prepare it.

```sh
# Install mkcert (for macOS)
brew install mkcert
mkcert -install

# Generate certificates
cd scratch-editor
mkdir -p .vscode
mkcert -key-file .vscode/localhost-key.pem -cert-file .vscode/localhost.pem localhost 127.0.0.1 0.0.0.0 ::1
```

The certificate paths are configured in [packages/scratch-gui/webpack.config.js](https://github.com/xcratch/scratch-editor/blob/xcratch/packages/scratch-gui/webpack.config.js).

### Extension Scaffolding

Move to the same level as scratch-editor and generate the extension scaffold using [xcratch-create](https://www.npmjs.com/package/xcratch-create).

```sh
cd ..  # Move to scratch-editor's parent directory
npx xcratch-create --repo=xcx-my-extension --account=githubAccount --extensionID=myExtension --extensionName='My Extension'
```

Main arguments:
- --repo: GitHub repository name
- --account: GitHub account
- --extensionID: Extension ID within Xcratch
- --extensionName: Extension name

### Repository Initialization

```sh
cd xcx-my-extension
git init -b main
git remote add origin <REPO_URL>
git add .
git commit -m "Scaffold code"
git push -u origin main
```

Install dependency packages. The template generated by xcratch-create is configured to use packages from within the monorepo for scratch-vm references.

```sh
npm install
```

### Setting Up scratch-vm References

Create symbolic links so you can reference scratch-vm source code (BlockType, Cast, etc.) during extension development.

```sh
npm run setup-dev
```

## Building and Watching

Generate modules using rollup.js-based scripts.

```sh
npm run build   # Create dist/extensionID.mjs
npm run watch   # Watch for changes and automatically build
```

## Loading and Debugging the Module

### Using VSCode Debug Features (Recommended)

Using scratch-editor's VSCode debug configuration, you can set breakpoints directly in your extension's source code for debugging.

#### 1. Workspace Setup

Add both scratch-editor and your extension to the VSCode workspace.

```
File > Add Folder to Workspace... > (Add scratch-editor and extension folders)
```

#### 2. Check launch.json

scratch-editor's [.vscode/launch.json](https://github.com/xcratch/scratch-editor/blob/xcratch/.vscode/launch.json) includes settings for resolving extension source maps.

```json
{
  "webRoot": "${workspaceFolder}/..",
  "sourceMapPathOverrides": {
    "webpack://GUI/*": "${webRoot}/scratch-editor/packages/scratch-gui/*",
    "webpack://GUI/scratch-vm/*": "${webRoot}/scratch-editor/packages/scratch-vm/*",
    "https://0.0.0.0:5500/*": "${webRoot}/*"
  }
}
```

The `https://0.0.0.0:5500/*` part is for resolving source maps when serving the extension via a local server.

#### 3. Build and Watch the Extension

Start watch mode in your extension directory.

```sh
cd xcx-my-extension
npm run watch
```

#### 4. Start Local HTTPS Server

Use Live Server to serve your extension directory over HTTPS.

Live Server Configuration Example

Configure to serve at `https://0.0.0.0:5500/` to match scratch-editor's launch.json.

.vscode/settings.json:

```json
{
  "liveServer.settings.port": 5500,
  "liveServer.settings.host": "0.0.0.0",
  "liveServer.settings.https": {
    "enable": true,
    "cert": "/path/to/localhost.pem",
    "key": "/path/to/localhost-key.pem"
  },
  "liveServer.settings.CustomBrowser": "chrome",
}
```

Set the workspace parent directory as the root so extension modules can be accessed.

xcx-my-extension.code-workspace:

```json
{
	"folders": [
		{
			"path": "xcx-my-extension"
		},
		{
			"path": "scratch-editor"
		}
	],
	"settings": {
		"liveServer.settings.root": "../",
		"liveServer.settings.multiRootWorkspaceName": "xcx-my-extension"
	}
}
```

#### 5. Start Debugging

1. Open scratch-editor in VSCode
2. Press F5 to launch "debug on dev-server"
3. Chrome will automatically open and navigate to `https://0.0.0.0:8601`
4. In Xcratch Editor, load your extension from "Load Extension"
   ```
   https://0.0.0.0:5500/<repo>/dist/<extensionID>.mjs
   ```
5. Set breakpoints in your extension's source files
6. Execute blocks to debug

### Loading via Local Web Server (Simple Method)

If not using VSCode debugging, you can serve your extension over HTTPS using Live Server or similar, and load it from the public Xcratch Editor (https://xcratch.github.io/editor/).

From "Load Extension" in Xcratch Editor, specify the following URL:

```
https://0.0.0.0:5500/<repo>/dist/<extensionID>.mjs
```

Your extension server must allow CORS from `https://xcratch.github.io/`.

## Distribution

### Distribution via GitHub Pages

Set the Pages source to `/(root)` in the `main` branch, and the module will be published as:

```
https://<account>.github.io/<repository>/dist/<extensionID>.mjs
```

If distributing on another server, also allow CORS from `https://xcratch.github.io/`.

## Sample Projects and Embedding

If you prepare a project using your extension's blocks as `projects/example.sb3`, it can be automatically opened with the extension loaded at:

```
https://xcratch.github.io/editor/#https://<account>.github.io/<repository>/projects/example.sb3
```

To embed only the player:

```html
<iframe src="https://xcratch.github.io/editor/player#https://<account>.github.io/<repository>/projects/example.sb3" width="600px" height="500px"></iframe>
```

For extensions using camera or microphone, you need to specify the allow option in iframe embedding.

```html
<iframe src="https://xcratch.github.io/editor/player#https://<account>.github.io/<repository>/projects/example.sb3" width="600px" height="500px" allow="camera; microphone;"></iframe>
```